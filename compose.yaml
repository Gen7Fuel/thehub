# services:
#   mongo:
#     container_name: mongo
#     image: mongo:8
#     volumes:
#       - mongodb_data:/data/db
#     ports:
#       - "127.0.0.1:27018:27017"
#     restart: always
#   redis:
#     container_name: redis
#     image: redis:7
#     volumes:
#       - redis_data:/data
#     command: ["redis-server", "--appendonly", "yes"]
#     restart: always
#   backend:
#     container_name: backend
#     build: ./backend
#     ports:
#       - "5000:5000"
#     environment:
#       - HOST=VPS
#       - FORCE_COLOR=1
#       - MONGO_URI=${MONGO_URI}
#       - JWT_SECRET=${JWT_SECRET}
#       - SQL_SERVER=${SQL_SERVER}
#       - SQL_DB=${SQL_DB}
#       - SQL_USER=${SQL_USER}
#       - SQL_PASSWORD=${SQL_PASSWORD}
#       - UPLOAD_SERVICE_URL=http://cdn:5001
#       - REDIS_URL=${REDIS_URL}
#       - SFTP_HOST=${SFTP_HOST}
#       - SFTP_PORT=${SFTP_PORT}
#       - SFTP_COUCHICHING_USER=${SFTP_COUCHICHING_USER}
#       - SFTP_COUCHICHING_PASS=${SFTP_COUCHICHING_PASS}
#       - SFTP_RANKIN_USER=${SFTP_RANKIN_USER}
#       - SFTP_RANKIN_PASS=${SFTP_RANKIN_PASS}
#       - SFTP_JOCKO_POINT_USER=${SFTP_JOCKO_POINT_USER}
#       - SFTP_JOCKO_POINT_PASS=${SFTP_JOCKO_POINT_PASS}
#       - SFTP_WALPOLE_USER=${SFTP_WALPOLE_USER}
#       - SFTP_WALPOLE_PASS=${SFTP_WALPOLE_PASS}
#       - SFTP_SARNIA_USER=${SFTP_SARNIA_USER}
#       - SFTP_SARNIA_PASS=${SFTP_SARNIA_PASS}
#       - SFTP_SILVER_GRIZZLY_USER=${SFTP_SILVER_GRIZZLY_USER}
#       - SFTP_SILVER_GRIZZLY_PASS=${SFTP_SILVER_GRIZZLY_PASS}
#       - SFTP_OLIVER_USER=${SFTP_OLIVER_USER}
#       - SFTP_OLIVER_PASS=${SFTP_OLIVER_PASS}
#       - SFTP_OSOYOOS_USER=${SFTP_OSOYOOS_USER}
#       - SFTP_OSOYOOS_PASS=${SFTP_OSOYOOS_PASS}
#       - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
#       - AZURE_CONTAINER=${AZURE_CONTAINER}
#     depends_on:
#       - mongo
#       - redis
#     restart: always
#   cdn:
#     container_name: cdn
#     build: ./cdn
#     volumes:
#       - uploads:/app/uploads
#     ports:
#       - "5001:5001"
#     depends_on:
#       - mongo
#     restart: always

#   # signaling:
#   #   container_name: signaling
#   #   build:
#   #     context: ./signaling
#   #     dockerfile: Dockerfile
#   #   ports:
#   #     - "5002:5002"
#   #   restart: always

#   frontend:
#     container_name: frontend
#     build: ./frontend
#     volumes:
#       - dist:/app/dist
#     depends_on:
#       - backend
#       - cdn
#     restart: no

#   caddy:
#     container_name: webserver
#     image: caddy:latest
#     ports:
#       - "3000:3000"
#     volumes:
#       - ./Caddyfile:/etc/caddy/Caddyfile
#       - dist:/usr/share/caddy
#     depends_on:
#       - frontend
#     restart: always

# volumes:
#   dist:
#   uploads:
#   mongodb_data:
#   redis_data:

# services:
#   mongo:
#     container_name: mongo
#     image: mongo:8
#     volumes:
#       - mongodb_data:/data/db
#     # Remove external port mapping to avoid public exposure
#     # ports:
#     #   - "127.0.0.1:27018:27017"
#     restart: always
#     networks:
#       default:
#         ipv4_address: 172.22.0.10  # static IP for SSH tunnel (optional)

#   redis:
#     container_name: redis
#     image: redis:7
#     volumes:
#       - redis_data:/data
#     command: ["redis-server", "--appendonly", "yes"]
#     restart: always

#   backend:
#     container_name: backend
#     build: ./backend
#     ports:
#       - "5000:5000"
#     environment:
#       - HOST=VPS
#       - FORCE_COLOR=1
#       - MONGO_URI=${MONGO_URI}        # use mongodb://mongo:27017/thehub
#       - JWT_SECRET=${JWT_SECRET}
#       - SQL_SERVER=${SQL_SERVER}
#       - SQL_DB=${SQL_DB}
#       - SQL_USER=${SQL_USER}
#       - SQL_PASSWORD=${SQL_PASSWORD}
#       - UPLOAD_SERVICE_URL=http://cdn:5001
#       - REDIS_URL=${REDIS_URL}
#       - SFTP_HOST=${SFTP_HOST}
#       - SFTP_PORT=${SFTP_PORT}
#       - SFTP_COUCHICHING_USER=${SFTP_COUCHICHING_USER}
#       - SFTP_COUCHICHING_PASS=${SFTP_COUCHICHING_PASS}
#       - SFTP_RANKIN_USER=${SFTP_RANKIN_USER}
#       - SFTP_RANKIN_PASS=${SFTP_RANKIN_PASS}
#       - SFTP_JOCKO_POINT_USER=${SFTP_JOCKO_POINT_USER}
#       - SFTP_JOCKO_POINT_PASS=${SFTP_JOCKO_POINT_PASS}
#       - SFTP_WALPOLE_USER=${SFTP_WALPOLE_USER}
#       - SFTP_WALPOLE_PASS=${SFTP_WALPOLE_PASS}
#       - SFTP_SARNIA_USER=${SFTP_SARNIA_USER}
#       - SFTP_SARNIA_PASS=${SFTP_SARNIA_PASS}
#       - SFTP_SILVER_GRIZZLY_USER=${SFTP_SILVER_GRIZZLY_USER}
#       - SFTP_SILVER_GRIZZLY_PASS=${SFTP_SILVER_GRIZZLY_PASS}
#       - SFTP_OLIVER_USER=${SFTP_OLIVER_USER}
#       - SFTP_OLIVER_PASS=${SFTP_OLIVER_PASS}
#       - SFTP_OSOYOOS_USER=${SFTP_OSOYOOS_USER}
#       - SFTP_OSOYOOS_PASS=${SFTP_OSOYOOS_PASS}
#       - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
#       - AZURE_CONTAINER=${AZURE_CONTAINER}
#     depends_on:
#       - mongo
#       - redis
#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
#       interval: 10s
#       timeout: 3s
#       retries: 5
#     restart: always

#   cdn:
#     container_name: cdn
#     build: ./cdn
#     volumes:
#       - uploads:/app/uploads
#     ports:
#       - "5001:5001"
#     depends_on:
#       - mongo
#     restart: always

#   frontend:
#     container_name: frontend
#     build: ./frontend
#     volumes:
#       - dist:/app/dist
#     depends_on:
#       - backend
#       - cdn
#     restart: no

#   caddy:
#     container_name: webserver
#     image: caddy:latest
#     ports:
#       - "3000:3000"
#     volumes:
#       - ./Caddyfile:/etc/caddy/Caddyfile
#       - dist:/usr/share/caddy
#     depends_on:
#       - frontend
#     restart: always

# volumes:
#   dist:
#   uploads:
#   mongodb_data:
#   redis_data:

# networks:
#   default:
#     driver: bridge
#     ipam:
#       config:
#         - subnet: 172.22.0.0/24   # allows static IP assignment





services:
  mongo:
    container_name: mongo
    image: mongo:8
    volumes:
      - mongodb_data:/data/db
    # Remove external port mapping to avoid public exposure
    # ports:
    #   - "127.0.0.1:27018:27017"
    restart: always
    networks:
      default:
        ipv4_address: 172.22.0.10  # static IP for SSH tunnel (optional)

  redis:
    container_name: redis
    image: redis:7
    volumes:
      - redis_data:/data
    command: ["redis-server", "--appendonly", "yes"]
    restart: always

  backend:
    container_name: backend
    build: ./backend
    expose:
      - "5000"
    environment:
      - HOST=VPS
      - FORCE_COLOR=1
      - MONGO_URI=${MONGO_URI}        # use mongodb://mongo:27017/thehub
      - JWT_SECRET=${JWT_SECRET}
      - SQL_SERVER=${SQL_SERVER}
      - SQL_DB=${SQL_DB}
      - SQL_USER=${SQL_USER}
      - SQL_PASSWORD=${SQL_PASSWORD}
      - UPLOAD_SERVICE_URL=http://cdn:5001
      - REDIS_URL=${REDIS_URL}
      - SFTP_HOST=${SFTP_HOST}
      - SFTP_PORT=${SFTP_PORT}
      - SFTP_COUCHICHING_USER=${SFTP_COUCHICHING_USER}
      - SFTP_COUCHICHING_PASS=${SFTP_COUCHICHING_PASS}
      - SFTP_RANKIN_USER=${SFTP_RANKIN_USER}
      - SFTP_RANKIN_PASS=${SFTP_RANKIN_PASS}
      - SFTP_JOCKO_POINT_USER=${SFTP_JOCKO_POINT_USER}
      - SFTP_JOCKO_POINT_PASS=${SFTP_JOCKO_POINT_PASS}
      - SFTP_WALPOLE_USER=${SFTP_WALPOLE_USER}
      - SFTP_WALPOLE_PASS=${SFTP_WALPOLE_PASS}
      - SFTP_SARNIA_USER=${SFTP_SARNIA_USER}
      - SFTP_SARNIA_PASS=${SFTP_SARNIA_PASS}
      - SFTP_SILVER_GRIZZLY_USER=${SFTP_SILVER_GRIZZLY_USER}
      - SFTP_SILVER_GRIZZLY_PASS=${SFTP_SILVER_GRIZZLY_PASS}
      - SFTP_OLIVER_USER=${SFTP_OLIVER_USER}
      - SFTP_OLIVER_PASS=${SFTP_OLIVER_PASS}
      - SFTP_OSOYOOS_USER=${SFTP_OSOYOOS_USER}
      - SFTP_OSOYOOS_PASS=${SFTP_OSOYOOS_PASS}
      - AZURE_STORAGE_CONNECTION_STRING=${AZURE_STORAGE_CONNECTION_STRING}
      - AZURE_CONTAINER=${AZURE_CONTAINER}
      - NOREPLY_PASS=${NOREPLY_PASS}
    depends_on:
      - mongo
      - redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: always

  auth-backend:
    container_name: auth-backend
    build: ./auth-backend
    ports:
      - "5005:5005"
    environment:
      - MONGO_URI=${MONGO_URI}
      - JWT_SECRET=${JWT_SECRET}
      - FORCE_COLOR=1
    volumes:
      - ./backend/models:/app/models:ro
    depends_on:
      - mongo
    healthcheck:
      # Matches the app.get('/auth/health') route you added
      test: ["CMD", "curl", "-f", "http://localhost:5005/auth/health"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: always

  cdn:
    container_name: cdn
    build: ./cdn
    volumes:
      - uploads:/app/uploads
    ports:
      - "5001:5001"
    depends_on:
      - mongo
    restart: always

  frontend:
    container_name: frontend
    build: ./frontend
    volumes:
      - dist:/app/dist
    depends_on:
      - backend
      - cdn
    restart: no

  caddy:
    container_name: webserver
    image: caddy:latest
    ports:
      - "3000:3000"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - /var/www/thehub:/usr/share/caddy
      - ./sage_static:/usr/share/caddy/dist_current/sage
    depends_on:
      backend:
        condition: service_healthy
      auth-backend:                    
        condition: service_started
    restart: always

volumes:
  dist:
  uploads:
  mongodb_data:
  redis_data:

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24   # allows static IP assignment