# name: Deploy to Server

# # Trigger on pushes to the main branch
# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # Step 1: Checkout repo (optional, mainly for GitHub Actions context)
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # Step 2: SSH to server and run deployment commands
#       - name: Deploy via SSH
#         uses: appleboy/ssh-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_HOST }}       # Server IP or hostname
#           username: ${{ secrets.SERVER_USER }}   # SSH username
#           key: ${{ secrets.SERVER_SSH_KEY }}     # Private SSH key from GitHub Secrets
#           script: |
#             cd /home/gen7fuel/thehub

#             export MONGO_URI=${{ secrets.MONGO_URI }}
#             export JWT_SECRET=${{ secrets.JWT_SECRET }}
#             export SQL_SERVER=${{ secrets.SQL_SERVER }}
#             export SQL_DB=${{ secrets.SQL_DB }}
#             export SQL_USER=${{ secrets.SQL_USER }}
#             export SQL_PASSWORD=${{ secrets.SQL_PASSWORD }}
#             export REDIS_URL=${{ secrets.REDIS_URL }}
#             export SFTP_HOST=${{ secrets.SFTP_HOST }}
#             export SFTP_PORT=${{ secrets.SFTP_PORT }}
#             export SFTP_COUCHICHING_USER=${{ secrets.SFTP_COUCHICHING_USER }}
#             export SFTP_COUCHICHING_PASS=${{ secrets.SFTP_COUCHICHING_PASS }}
#             export SFTP_RANKIN_USER=${{ secrets.SFTP_RANKIN_USER }}
#             export SFTP_RANKIN_PASS=${{ secrets.SFTP_RANKIN_PASS }}
#             export SFTP_JOCKO_POINT_USER=${{ secrets.SFTP_JOCKO_POINT_USER }}
#             export SFTP_JOCKO_POINT_PASS=${{ secrets.SFTP_JOCKO_POINT_PASS }}
#             export SFTP_WALPOLE_USER=${{ secrets.SFTP_WALPOLE_USER }}
#             export SFTP_WALPOLE_PASS=${{ secrets.SFTP_WALPOLE_PASS }}
#             export SFTP_SARNIA_USER=${{ secrets.SFTP_SARNIA_USER }}
#             export SFTP_SARNIA_PASS=${{ secrets.SFTP_SARNIA_PASS }}
#             export SFTP_SILVER_GRIZZLY_USER=${{ secrets.SFTP_SILVER_GRIZZLY_USER }}
#             export SFTP_SILVER_GRIZZLY_PASS=${{ secrets.SFTP_SILVER_GRIZZLY_PASS }}
#             export SFTP_OLIVER_USER=${{ secrets.SFTP_OLIVER_USER }}
#             export SFTP_OLIVER_PASS=${{ secrets.SFTP_OLIVER_PASS }}
#             export SFTP_OSOYOOS_USER=${{ secrets.SFTP_OSOYOOS_USER }}
#             export SFTP_OSOYOOS_PASS=${{ secrets.SFTP_OSOYOOS_PASS }}
#             export AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
#             export AZURE_CONTAINER=${{ secrets.AZURE_CONTAINER }}

#             git pull origin main
#             docker compose down
#             docker volume rm thehub_dist || true
#             docker compose up --build -d
#             docker exec -i redis redis-cli replicaof no one
#             docker exec -i redis redis-cli SAVE


name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v4

      # 2. Setup Node (GitHub runner ONLY)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 23

      # 3. Build frontend on GitHub
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build

      # 4. Copy built frontend to VPS
      - name: Copy frontend build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "frontend/dist"
          target: "/tmp/frontend-dist"

      # 5. Deploy on VPS (NO npm here)
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd /home/gen7fuel/thehub

            git pull origin main

            # ---- ENV VARS ----
            export MONGO_URI=${{ secrets.MONGO_URI }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export SQL_SERVER=${{ secrets.SQL_SERVER }}
            export SQL_DB=${{ secrets.SQL_DB }}
            export SQL_USER=${{ secrets.SQL_USER }}
            export SQL_PASSWORD=${{ secrets.SQL_PASSWORD }}
            export REDIS_URL=${{ secrets.REDIS_URL }}
            export SFTP_HOST=${{ secrets.SFTP_HOST }}
            export SFTP_PORT=${{ secrets.SFTP_PORT }}
            export SFTP_COUCHICHING_USER=${{ secrets.SFTP_COUCHICHING_USER }}
            export SFTP_COUCHICHING_PASS=${{ secrets.SFTP_COUCHICHING_PASS }}
            export SFTP_RANKIN_USER=${{ secrets.SFTP_RANKIN_USER }}
            export SFTP_RANKIN_PASS=${{ secrets.SFTP_RANKIN_PASS }}
            export SFTP_JOCKO_POINT_USER=${{ secrets.SFTP_JOCKO_POINT_USER }}
            export SFTP_JOCKO_POINT_PASS=${{ secrets.SFTP_JOCKO_POINT_PASS }}
            export SFTP_WALPOLE_USER=${{ secrets.SFTP_WALPOLE_USER }}
            export SFTP_WALPOLE_PASS=${{ secrets.SFTP_WALPOLE_PASS }}
            export SFTP_SARNIA_USER=${{ secrets.SFTP_SARNIA_USER }}
            export SFTP_SARNIA_PASS=${{ secrets.SFTP_SARNIA_PASS }}
            export SFTP_SILVER_GRIZZLY_USER=${{ secrets.SFTP_SILVER_GRIZZLY_USER }}
            export SFTP_SILVER_GRIZZLY_PASS=${{ secrets.SFTP_SILVER_GRIZZLY_PASS }}
            export SFTP_OLIVER_USER=${{ secrets.SFTP_OLIVER_USER }}
            export SFTP_OLIVER_PASS=${{ secrets.SFTP_OLIVER_PASS }}
            export SFTP_OSOYOOS_USER=${{ secrets.SFTP_OSOYOOS_USER }}
            export SFTP_OSOYOOS_PASS=${{ secrets.SFTP_OSOYOOS_PASS }}
            export AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
            export AZURE_CONTAINER=${{ secrets.AZURE_CONTAINER }}

            # ---- FRONTEND ATOMIC SWAP ----
            TMP_DIR=/tmp/frontend-dist/dist
            DIST_VOL=/var/lib/docker/volumes/thehub_dist/_data

            test -d "$TMP_DIR" || { echo "Frontend dist missing"; exit 1; }

            mv $DIST_VOL ${DIST_VOL}_old || true
            cp -r $TMP_DIR $DIST_VOL
            rm -rf ${DIST_VOL}_old

            # ---- BACKEND ROLLING UPDATE ----
            docker compose up -d --build --no-deps --wait backend

            # ---- REDIS SAFETY ----
            docker exec -i redis redis-cli replicaof no one
            docker exec -i redis redis-cli SAVE
