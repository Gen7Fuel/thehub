# name: Deploy to Server

# # Trigger on pushes to the main branch
# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # Step 1: Checkout repo (optional, mainly for GitHub Actions context)
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # Step 2: SSH to server and run deployment commands
#       - name: Deploy via SSH
#         uses: appleboy/ssh-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_HOST }}       # Server IP or hostname
#           username: ${{ secrets.SERVER_USER }}   # SSH username
#           key: ${{ secrets.SERVER_SSH_KEY }}     # Private SSH key from GitHub Secrets
#           script: |
#             cd /home/gen7fuel/thehub

#             export MONGO_URI=${{ secrets.MONGO_URI }}
#             export JWT_SECRET=${{ secrets.JWT_SECRET }}
#             export SQL_SERVER=${{ secrets.SQL_SERVER }}
#             export SQL_DB=${{ secrets.SQL_DB }}
#             export SQL_USER=${{ secrets.SQL_USER }}
#             export SQL_PASSWORD=${{ secrets.SQL_PASSWORD }}
#             export REDIS_URL=${{ secrets.REDIS_URL }}
#             export SFTP_HOST=${{ secrets.SFTP_HOST }}
#             export SFTP_PORT=${{ secrets.SFTP_PORT }}
#             export SFTP_COUCHICHING_USER=${{ secrets.SFTP_COUCHICHING_USER }}
#             export SFTP_COUCHICHING_PASS=${{ secrets.SFTP_COUCHICHING_PASS }}
#             export SFTP_RANKIN_USER=${{ secrets.SFTP_RANKIN_USER }}
#             export SFTP_RANKIN_PASS=${{ secrets.SFTP_RANKIN_PASS }}
#             export SFTP_JOCKO_POINT_USER=${{ secrets.SFTP_JOCKO_POINT_USER }}
#             export SFTP_JOCKO_POINT_PASS=${{ secrets.SFTP_JOCKO_POINT_PASS }}
#             export SFTP_WALPOLE_USER=${{ secrets.SFTP_WALPOLE_USER }}
#             export SFTP_WALPOLE_PASS=${{ secrets.SFTP_WALPOLE_PASS }}
#             export SFTP_SARNIA_USER=${{ secrets.SFTP_SARNIA_USER }}
#             export SFTP_SARNIA_PASS=${{ secrets.SFTP_SARNIA_PASS }}
#             export SFTP_SILVER_GRIZZLY_USER=${{ secrets.SFTP_SILVER_GRIZZLY_USER }}
#             export SFTP_SILVER_GRIZZLY_PASS=${{ secrets.SFTP_SILVER_GRIZZLY_PASS }}
#             export SFTP_OLIVER_USER=${{ secrets.SFTP_OLIVER_USER }}
#             export SFTP_OLIVER_PASS=${{ secrets.SFTP_OLIVER_PASS }}
#             export SFTP_OSOYOOS_USER=${{ secrets.SFTP_OSOYOOS_USER }}
#             export SFTP_OSOYOOS_PASS=${{ secrets.SFTP_OSOYOOS_PASS }}
#             export AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
#             export AZURE_CONTAINER=${{ secrets.AZURE_CONTAINER }}

#             git pull origin main
#             docker compose down
#             docker volume rm thehub_dist || true
#             docker compose up --build -d
#             docker exec -i redis redis-cli replicaof no one
#             docker exec -i redis redis-cli SAVE


name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - uses: actions/checkout@v4

      # 2. Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 23

      # 3. Build frontend
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          rm -rf dist  # <--- FORCE DELETE OLD BUILD
          npm run build
          VERSION=$(date +%Y%m%d%H%M%S)-${GITHUB_SHA::7}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # 4. Copy frontend build to server
      - name: Copy frontend build to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "frontend/dist/*"   # Add /* to get the contents
          strip_components: 2        # This removes 'frontend/' and 'dist/' from the folder structure
          target: "/tmp/frontend-dist/${{ env.VERSION }}"

      # 5. Deploy backend + frontend
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd /home/gen7fuel/thehub

            # ---- Pull backend ----
            git pull origin main

            # ---- Export env vars ----
            export MONGO_URI=${{ secrets.MONGO_URI }}
            export JWT_SECRET=${{ secrets.JWT_SECRET }}
            export SQL_SERVER=${{ secrets.SQL_SERVER }}
            export SQL_DB=${{ secrets.SQL_DB }}
            export SQL_USER=${{ secrets.SQL_USER }}
            export SQL_PASSWORD=${{ secrets.SQL_PASSWORD }}
            export REDIS_URL=${{ secrets.REDIS_URL }}
            export SFTP_HOST=${{ secrets.SFTP_HOST }}
            export SFTP_PORT=${{ secrets.SFTP_PORT }}
            export SFTP_COUCHICHING_USER=${{ secrets.SFTP_COUCHICHING_USER }}
            export SFTP_COUCHICHING_PASS=${{ secrets.SFTP_COUCHICHING_PASS }}
            export SFTP_RANKIN_USER=${{ secrets.SFTP_RANKIN_USER }}
            export SFTP_RANKIN_PASS=${{ secrets.SFTP_RANKIN_PASS }}
            export SFTP_JOCKO_POINT_USER=${{ secrets.SFTP_JOCKO_POINT_USER }}
            export SFTP_JOCKO_POINT_PASS=${{ secrets.SFTP_JOCKO_POINT_PASS }}
            export SFTP_WALPOLE_USER=${{ secrets.SFTP_WALPOLE_USER }}
            export SFTP_WALPOLE_PASS=${{ secrets.SFTP_WALPOLE_PASS }}
            export SFTP_SARNIA_USER=${{ secrets.SFTP_SARNIA_USER }}
            export SFTP_SARNIA_PASS=${{ secrets.SFTP_SARNIA_PASS }}
            export SFTP_SILVER_GRIZZLY_USER=${{ secrets.SFTP_SILVER_GRIZZLY_USER }}
            export SFTP_SILVER_GRIZZLY_PASS=${{ secrets.SFTP_SILVER_GRIZZLY_PASS }}
            export SFTP_OLIVER_USER=${{ secrets.SFTP_OLIVER_USER }}
            export SFTP_OLIVER_PASS=${{ secrets.SFTP_OLIVER_PASS }}
            export SFTP_OSOYOOS_USER=${{ secrets.SFTP_OSOYOOS_USER }}
            export SFTP_OSOYOOS_PASS=${{ secrets.SFTP_OSOYOOS_PASS }}
            export AZURE_STORAGE_CONNECTION_STRING=${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
            export AZURE_CONTAINER=${{ secrets.AZURE_CONTAINER }}
            export NOREPLY_PASS=${{ secrets.NOREPLY_PASS }}
            export INTACCT_CLIENT_ID=${{ secrets.INTACCT_CLIENT_ID }}
            export INTACCT_CLIENT_SECRET=${{ secrets.INTACCT_CLIENT_SECRET }}
            export INTACCT_CALLBACK_URL=${{ secrets.INTACCT_CALLBACK_URL }}

            # ---- Deploy Auth-Backend ----
            # docker compose up -d --build --no-deps --wait auth-backend
            
            # ---- Backend rolling update ----
            # docker compose up -d --build --no-deps --wait backend

            # ---- 1. Deploy Auth-Backend with Safety ----
            echo "Deploying auth-backend..."
            if docker compose up -d --build --no-deps --wait auth-backend; then
                echo "SUCCESS: Auth-backend is healthy."
            else
                echo "FATAL: Auth-backend failed health check!"
                docker logs auth-backend --tail 50
                echo "Rolling back auth-backend..."
                docker compose up -d auth-backend
                exit 1
            fi

            # ---- 2. Deploy Main Backend with Safety ----
            echo "Deploying backend..."
            if docker compose up -d --build --no-deps --wait backend; then
                echo "SUCCESS: Backend is healthy."
            else
                echo "FATAL: Backend failed health check!"
                # This captures the 'Module Not Found' or 'Mongoose' errors
                docker logs backend --tail 50
                echo "Rolling back main backend..."
                docker compose up -d backend
                exit 1
            fi

            # ---- Frontend zero-downtime update ----
            VERSION=${{ env.VERSION }}
            TMP_DIR=/tmp/frontend-dist/$VERSION
            NEW_DIR=/var/www/thehub/$VERSION
            CURRENT_DIR=/var/www/thehub/dist_current

            # 1. Create a fresh versioned folder (ensure it's empty)
            sudo rm -rf $NEW_DIR
            sudo mkdir -p $NEW_DIR

            # 2. Copy from tmp to the versioned folder
            sudo cp -rp $TMP_DIR/. $NEW_DIR/

            # 3. FIX PERMISSIONS (Ensures Caddy can read the new files)
            sudo chown -R gen7fuel:gen7fuel $NEW_DIR
            sudo chmod -R 755 $NEW_DIR

            # 4. ATOMIC RELATIVE SYMLINK (Crucial for Docker)
            # We 'cd' into the directory so the link is "2025... -> dist_current" 
            # instead of "/var/www/thehub/2025... -> dist_current"
            cd /var/www/thehub
            sudo ln -sfn $VERSION dist_current

            # 5. Reload Caddy
            # docker exec webserver caddy reload --config /etc/caddy/Caddyfile
            
            # ---- 5. Safe Caddy Update with Mandatory Cleanup ----
            echo "Validating new Caddyfile..."

            # 1. Push to a temporary file
            docker exec -i webserver sh -c "cat > /etc/caddy/Caddyfile.new" < /home/gen7fuel/thehub/Caddyfile

            # 2. Validate the temporary file
            if docker exec webserver caddy validate --config /etc/caddy/Caddyfile.new; then
                echo "Validation passed. Applying new config..."
                # Overwrite the real file and reload
                docker exec webserver sh -c "mv /etc/caddy/Caddyfile.new /etc/caddy/Caddyfile"
                docker exec webserver caddy reload --config /etc/caddy/Caddyfile
                echo "Caddy reloaded successfully."
                # We don't need to 'rm' here because 'mv' already moved/renamed it
            else
                echo "FATAL: New Caddyfile has syntax errors!"
                # Cleanup the failed file
                docker exec webserver rm /etc/caddy/Caddyfile.new
                echo "Temporary files cleaned up. Keeping old configuration."
                exit 1
            fi

            # ---- Cleanup ----
            # Keep only the 3 most recent versions
            cd /var/www/thehub && ls -1dt 202* | tail -n +4 | xargs sudo rm -rf
            
            # Clean up the /tmp folder so it doesn't grow forever
            sudo rm -rf /tmp/frontend-dist/

            # ---- Redis safety ----
            docker exec -i redis redis-cli replicaof no one
            docker exec -i redis redis-cli SAVE